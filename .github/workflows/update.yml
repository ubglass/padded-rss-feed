name: RSS Feed - Titles Only (Padded)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get install -y xmlstarlet

      - name: Fetch original RSS
        run: |
          curl -L "$(cat rss-source.txt)" -o raw.xml

      - name: Build a titles-only feed
        run: |
          PAD="&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;"

          # Start from a clean copy
          cp raw.xml rss.xml

          echo "Removing all descriptions, links, content blocks, images, HTML..."
          xmlstarlet ed \
            -d "//description" \
            -d "//link" \
            -d "//content:encoded" \
            -d "//media:content" \
            -d "//guid" \
            -d "//pubDate" \
            -d "//dc:creator" \
            rss.xml > tmp.xml && mv tmp.xml rss.xml

          echo "Padding titles only..."
          COUNT=$(xmlstarlet sel -t -v "count(/rss/channel/item)" rss.xml)

          for i in $(seq 1 $COUNT); do
            TITLE=$(xmlstarlet sel -t -v "/rss/channel/item[$i]/title" rss.xml | sed 's/<[^>]*>//g')
            xmlstarlet ed -u "/rss/channel/item[$i]/title" -v "$PAD$TITLE" rss.xml > tmp.xml && mv tmp.xml rss.xml
          done

      - name: Commit padded titles-only feed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rss.xml
          git commit -m "Updated titles-only padded feed" || echo "No changes"
          git push
