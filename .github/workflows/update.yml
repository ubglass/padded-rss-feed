name: Update Padded RSS Feed

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install XML tools
        run: sudo apt-get install -y xmlstarlet

      - name: Fetch source feed
        run: |
          curl -L "$(cat rss-source.txt)" -o original.xml

      - name: Clean and Pad Feed for Dakboard
        run: |
          PAD="&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;"

          cp original.xml rss-working.xml

          echo "Removing <content:encoded> (Dakboard pulls this preferentially)..."
          xmlstarlet ed -d "//content:encoded" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml

          echo "Clean Channel Title + Link..."
          for TAG in title link; do
            CONTENT=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/$TAG)" rss-working.xml)
            xmlstarlet ed -u "/rss/channel/$TAG" -v "$PAD$CONTENT" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml
          done

          echo "Clean Channel Description..."
          CH_DESC=$(xmlstarlet sel -t -c "/rss/channel/description" rss-working.xml | sed 's/<[^>]*>//g')
          xmlstarlet ed -u "/rss/channel/description" -v "$PAD$CH_DESC" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml

          echo "Processing item nodes..."
          COUNT=$(xmlstarlet sel -t -v "count(/rss/channel/item)" rss-working.xml)

          for i in $(seq 1 $COUNT); do

            # TITLE
            T=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/item[$i]/title)" rss-working.xml)
            xmlstarlet ed -u "/rss/channel/item[$i]/title" -v "$PAD$T" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml

            # DESCRIPTION (strip HTML â†’ plain text)
            D=$(xmlstarlet sel -t -c "/rss/channel/item[$i]/description" rss-working.xml | sed 's/<[^>]*>//g')
            xmlstarlet ed -u "/rss/channel/item[$i]/description" -v "$PAD$D" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml

            # LINK
            L=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/item[$i]/link)" rss-working.xml)
            xmlstarlet ed -u "/rss/channel/item[$i]/link" -v "$PAD$L" rss-working.xml > tmp.xml && mv tmp.xml rss-working.xml

          done

          mv rss-working.xml rss.xml

      - name: Commit and Push Result
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rss.xml
          git commit -m "Updated padded + cleaned feed" || echo "No changes"
          git push
