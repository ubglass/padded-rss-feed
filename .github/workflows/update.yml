name: Update Padded RSS Feed

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # every hour

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install XML tools
        run: sudo apt-get install -y xmlstarlet

      - name: Fetch source feed
        run: |
          curl -L "$(cat rss-source.txt)" -o original.xml

      - name: Apply 60-EM padding to entire feed
        run: |
          # 60 EM spaces (U+2003)
          PAD="&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;"

          cp original.xml rss-working.xml

          echo "Padding channel tags (title, link)..."

          # ---- CHANNEL LEVEL: TITLE + LINK ----
          for TAG in title link; do
            CONTENT=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/$TAG)" original.xml)
            xmlstarlet ed -u "/rss/channel/$TAG" -v "$PAD$CONTENT" rss-working.xml > tmp && mv tmp rss-working.xml
          done

          echo "Padding channel description (HTML inside CDATA)..."

          # CHANNEL DESCRIPTION (HTML preserved)
          CH_DESC=$(xmlstarlet sel -t -c "/rss/channel/description" original.xml | sed 's/<description>//;s/<\/description>//')
          xmlstarlet ed -u "/rss/channel/description" -v "<![CDATA[$PAD$CH_DESC]]>" rss-working.xml > tmp && mv tmp rss-working.xml

          echo "Padding item-level fields..."

          COUNT=$(xmlstarlet sel -t -v "count(/rss/channel/item)" original.xml)

          for i in $(seq 1 $COUNT); do

            # TITLE
            T=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/item[$i]/title)" original.xml)
            xmlstarlet ed -u "/rss/channel/item[$i]/title" -v "$PAD$T" rss-working.xml > tmp && mv tmp rss-working.xml

            # DESCRIPTION (HTML preserved inside CDATA)
            D=$(xmlstarlet sel -t -c "/rss/channel/item[$i]/description" original.xml | sed 's/<description>//;s/<\/description>//')
            xmlstarlet ed -u "/rss/channel/item[$i]/description" -v "<![CDATA[$PAD$D]]>" rss-working.xml > tmp && mv tmp rss-working.xml

            # LINK
            L=$(xmlstarlet sel -t -v "normalize-space(/rss/channel/item[$i]/link)" original.xml)
            xmlstarlet ed -u "/rss/channel/item[$i]/link" -v "$PAD$L" rss-working.xml > tmp && mv tmp rss-working.xml

          done

          mv rss-working.xml rss.xml

      - name: Commit and Push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rss.xml
          git commit -m "Updated padded RSS feed" || echo "No changes to commit"
          git push
